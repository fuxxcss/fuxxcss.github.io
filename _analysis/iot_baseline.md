---
title: "消费级物联网，从安全基线到攻击面"
excerpt: '从《消费级物联网安全基线》4.0到攻击面'

collection: analysis
category: xiot
permalink: /analysis/iot-baseline
tags: 
  - iot
  - xiaomi
  - attack surface

layout: single
read_time: true
author_profile: false
comments: true
share: true
related: true
---

## 《消费级物联网安全基线》4.0

2021年初，小米作为物联网安全领域的践行者，首次对外发布了《消费级物联网安全基线》，向物联网企业提供了一份开放的安全要求实施指南。小米内部及合作厂商依据此安全基线对各品类物联网产品进行安全评估和安全检测工作，我们真切地感受到在基线的指引下，物联网产品安全能力大幅度的提升[^1]。

![](../images/analysis/xiaomi/iot_baseline_cover.png)

2024年1月，小米正式对外发布《消费级物联网安全基线》4.0版本，4.0版本从行业发展以及落地实施角度出发[^1]：
1. 优化修改了 33 项安全要求描述，细化落地规范易于理解；
2. 新增 2 项针对 Android 系统的通用要求，并包含 1 个通用参考解决方案；
3. 新增 3 项技术通用解决方案和要求，细化米家安全芯片建议型号并补充完善米家三元组 Key 安全方案；
4. 补充新增 5 项针对门锁品类特殊安全要求（符合即将发版 GA 374-2023 要求），并包含 1 个通用参考解决方案；
5. 优化 PDF 易读性（通用 / 参考方案合并到正文、正文增加要求适用等级、目录跳转等）；

## 安全基线与攻击面

要想说清楚安全基线与攻击面，首先理解二者的定义：
- 攻击面[^2]，是指漏洞、途径或方法（有时称为攻击媒介）的总和，攻击者可以利用这些漏洞、途径或方法获取对网络或敏感数据进行未经授权访问或者实施网络攻击。
- 安全基线，是一个信息系统的最小安全保证。信息系统安全往往需要在安全付出成本与所能够承受的安全风险之间进行平衡, 而安全基线正是这个平衡的合理分界线。

由此可见，通过学习安全基线，可以根据安全防护策略推导出攻击面；通过学习攻击面，可以据此完善安全基线。本文从《消费级物联网安全基线》4.0出发，学习消费级物联网的安全基线与攻击面。

## 设备硬件

### 一、调试接口关闭、鉴权、输入输出

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 调试接口，如TX、RX、UART、JTAG、SWD、ADB | 中 | 鉴权 |
| | 中 | 输入输出控制 |
| | 高 | 永久关闭 |

<font color=Blue>中级策略</font> **鉴权**
设备正式版本固件默认关闭调试接口，需要开启时进行鉴权。有以下3种鉴权方式：
1. 云端鉴权，在芯片 efuse 烧录一机一密，需要登录账号密码从云端拉取设备刷机密码，在线刷工具输入并验证该密码正确后才可进行线刷。
2. 加密鉴权，如使用私有USB Dongle串接使用进行鉴权加密等。
3. 物理鉴权，飞线通联，需要调试时使用导线焊接到 PCB 的调试节点使调试接口电路通联；特殊操作，如特殊按键组合、设备倾斜通电等。

攻击面：
1. 云端设备刷机密码泄漏
2. 低安全等级设备，物理鉴权方案泄漏

<font color=Blue>中级策略</font> **输入输出控制**
关闭信息输入：开启调试接口时，关闭调试接口的信息输入，防止设备固件被篡改或本地存储的敏感信息被读取。

关闭敏感信息输出：开启调试接口时，log输出不包含用户与设备敏感信息（敏感安全参数如 key、token，个人敏感信息如 password、Wi-Fi密码等），如需输出完整数据流日志，需要将此类信息遮蔽展示（如：password ：********）。

攻击面：
...

<font color=Red>高级策略</font> **永久关闭**
从软件、硬件两个途径永久关闭调试接口，防止从调试接口getshell：
1. 根据 MCU/SoC 的芯片技术手册，在芯片 efuse 烧录对应的安全配置字段，一次性永久关闭调试接口。
2. 设备去除 PCB 板上的调试接口丝印，以防止逆向工程。

攻击面：
...

### 二、敏感数据加密、防篡改

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 敏感数据，如公私钥、证书，设备唯一标识符（如 SN、IMEI、Device ID） | 高 | 加密存储 |
| | 高 | 防篡改 |

<font color=Red>高级策略</font> **加密存储**
将敏感信息加密存储在存储芯片（flash、nand、emmc 等），加密方案可通过采用集成具备数据加密能力的安全芯片、TEE 或操作系统分区加密来实现。

攻击面：
1. 采用了加密措施，但是调试接口开启且未控制输入输出。

<font color=Red>高级策略</font> **防篡改**
设备用于存储保护、传输保护和鉴权的公私钥、证书等需要防止被篡改的敏感信息，和用于识别或验证设备身份合法性的设备唯一标识符，除加密存储外，应存储在设备不可被外部篡改的分区内，如 flash 只读分区、安全芯片或 TEE 中。


攻击面：
1. 采用了防篡改措施，但是调试接口开启且未控制输入输出。

### 三、芯片间通信加密

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 芯片间通信协议（UART/IIC/SPI/USB等）传输的数据 | 高 | 加密通信 |

<font color=Red>高级策略</font> **加密通信**
设备对芯片间通信协议传输的数据本身进行加密，有以下2种方案：
1. 采用安全芯片（SE）或可信执行环境（TEE）来确保加密密钥的安全性，并在 TEE 内实现敏感信息加解密和密钥管理等功能。
2. 对于未集成安全芯片和不支持可信执行环境的设备，设备关键MCU 之间首次上电后宜互相协商通信密钥（芯片间通过串口 ECC 生成公私钥对，计算临时密钥，生成随机数和挑战值，验证挑战值，验证通过后使用 LTK 做鉴权密钥），并存储在外部没有访问权限的存储分区。

攻击面：
...

### 四、安全启动

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 固件、Flash关键分区 | 中 | BL启动保护 |
| | 高 | 固件校验 |

<font color=Blue>中级策略</font> **bootloader启动保护**
设备 BootLoader 不应在系统启动前预留中断时间，Delay 需设置为 0，防止通过修改启动参数进入 SHELL 界面获得设备控制权。
当设备操作系统引导加载程序（Bootloader/U-Boot）启动异常后，设备操作系统应自动重启，避免启动异常后暴露操作系统引导加载控制台（Console）界面，以防止攻击者通过错误植入进入到控制台界面，来获得篡改设备启动参数的权限，从而控制设备。

<font color=Red>高级策略</font> **固件校验**
从设备上电开始，依次对固件（bootloader、kernel、rootfs）或 Flash 关键分区（如固件程序所在分区）进行合法加载校验，确保存储芯片中的系统合法性和完整性校验通过后才能正常启动。

攻击面：
...

## 设备软件

### 一、固件升级保护

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 固件 | 低 | 失败后恢复 |
| | 中 | 第三方组建更新 |
| | 高 | 升级包校验 |

<font color=Green>低级策略</font> **失败后恢复**
设备软件更新时可能遇到断电等特殊情况，导致设备升级失败。因此设备应具备 OTA 双分区备份机制，保障升级失败时能恢复到可用软件版本，防止升级失败损害设备可用性。

<font color=Blue>中级策略</font> **第三方组建更新**
设备使用到的第三方软件 / 库 / 开源代码应使用最新版本，不应使用老旧或已停止维护的版本，不应使用无 licence 或来源不明的代码或库，如特殊需求不能使用最新版本，应经过安全评估。在明确安全漏洞的情况下，应及时更新到最新修复版本。

<font color=Red>高级策略</font> **升级包校验**
设备固件升级前应先对固件包进行合法性校验，防止恶意固件刷入，或者固件降级攻击，导致旧版本可能存在的历史漏洞或安全风险重新暴露被利用。固件升级有3种途径：
1. OTA远程升级
2. 局域网升级
3. 设备通过硬件线刷，包括IAP线刷，ICP/ISP 线刷

固件升级前应先对固件包进行完整性哈希得到固件包摘要，再使用公私钥方式对摘要进行合法性签名和验签，确认升级包完整性与合法性再进行更新，以防止固件包被篡改或替换。

### 二、服务与端口最小化

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 服务与端口 | 中 | 最小化 |

<font color=Blue>中级策略</font> **最小化**
对服务、端口进行最小化处理：
1. 高风险服务与非必要端口，设备应默认关闭 FTP、SSH、Telnet、HTTP、ADB 等高风险管理服务或信息数据服务，如需开启应经过安全评估，也应关闭非数据交互与控制实现所必要的 IoT SDK 控制服务端口。
2. 设备端口协议：设备局域网端口应使用 IPv4 协议，设备互联网端口应按照业务功能需求选择使用 IPv4 或IPv6 协议，如设备无 IPv6 协议使用需求应关闭 IPv6 协议。

### 三、代码信息防泄漏

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 代码 | 低 | 不公开源代码 |
| | 低 | 正式版本 |

<font color=Green>低级策略</font> **不公开源代码**
设备相关代码库不应在未经允许的情况下上传至 Github、Gitee等公用代码仓库或百度网盘等公开、半公开服务，防止源代码泄露。

<font color=Green>低级策略</font> **正式版本**
设备应严格区分使用的小米 SDK、设备固件的版本类型，正式固件应基于用户 /release 版本编译，不应使用开发调试 /debug 版本编译正式版本，防止开发调试 /debug 版本中存在的特权接口、调试和产测等功能引入安全风险。

## 设备OS

### 一、权限控制

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 设备权限控制机制 | 低 | 密码管理 |
| | 中 | 防暴力破解 |
| | 中 | 文件系统权限控制 |
| | 高 | 外部存储执行权限控制 |

<font color=Green>低级策略</font> **密码管理**
对于有/无UI的登录验证，都需要预设高强度密码（长度 10-14 位，包含大写字母、小写字母、符号和数字其中三类字符）：
1. 无 UI 登录，嵌入式 Linux 系统默认用户（如 root、admin 等）需设置高强度密码，并保证一机一密，不应在代码中为所有设备写入相同密码或空密码。
2. 有 UI 登录，如果用户注册 / 登录设备的用户账户 / 管理后台预置了默认密码，则该密码应为随机生成且一机一密的高强度密码，并在用户首次登陆时强制要求修改默认密码；如果设备不为用户注册 / 登录设备的用户账户 / 管理后台预置默认密码，则设备应要求用户注册或首次登录时自行设置高强度密码。

<font color=Blue>中级策略</font> **防暴力破解**
不同品类的设备，防暴力破解策略不同：
1. 通用品类，需要在设备端登录密码的设备（仅路由器、门锁、电视、投影仪、带屏音箱等） ，其登录密码应具备防暴力破解机制，如验证码等人机交互机制、登录验证失败递增等待时间和登录验证失败超过一定次数锁定账号等。 用于累计登录验证失败次数的计数器应严格计算，防止通过按取消键可绕过计数等情况。
2. 门锁品类，未授权的所有技术认证手段（包含但不限于数字钥匙、PIN 钥匙、生物钥匙）在 5min 内连续错误输入次数累计之和达到 5 次后，锁端应给出报警提示信息，同时锁端应自动进入无效输入状态且至少持续 90s。

<font color=Blue>中级策略</font> **文件系统权限控制**
设备嵌入式 Linux 的基础文件系统（如 /etc/ 等存有启动项的目录）应使用只读文件系统（如 squashfs、cramfs），以防止攻击者在篡改运行状态的操作系统。
（由于 squashfs 不具备 flash 坏块处理机制，如果 NAND flash 设备的 OTA 等功能对坏块处理能力要求较高，可使用 UBI 文件系统，并且把设备根目录配置为只读，也满足安全要求。）

<font color=Red>高级策略</font> **外部存储执行权限控制**
设 备 嵌 入 式 Linux 操 作系统默认不应运行外部存储（SD 卡、U 盘、网络存储等）中程序或脚本。如有特殊需要，应进行公私钥签名验证，以防止系统被植入恶意软件或脚本。

### 二、输入验证

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 用户界面或 API 接口 | 高 | 输入验证 |

<font color=Red>高级策略</font> **输入验证**
设备应验证通过用户界面或 API 接口输入的数据，以防止设备执行外部恶意攻击代码。
根据验证方法包括过滤超出处理范围的数据、过滤和转义非预期的数据类型，及部署 fuzz 工具检测程序是否存在输入数据验证不足而出现的潜在漏洞等。

### 三、内存安全

| 基线对象 | 策略级别 | 具体策略 |
| :-: | :-: | :-: |
| 漏洞利用缓解 | 低 | ASLR、PIE |
| | 低 | Stack Canary |
| | 低 | NX |
| | 低 | Stripped |

<font color=Green>低级策略</font> **ASLR、PIE**
嵌入式 Linux 系统的设备应开启地址空间布局随机化（ASLR）保护措施，以防止缓冲区溢出。
``` shell
kernel.randomize_va_space=2 > /etc/sysctl.conf
```
编译时应开启 PIE 应用基址随机加载保护选项，搭配ASLR。
``` shell
gcc -pie -fPIE
```

<font color=Green>低级策略</font> **Stack Canary**
在编译 Linux 程序代码时，应开启 Linux 程序的 CANARY 栈溢出保护选项。
``` shell
gcc -fstack-protector-all
```

<font color=Green>低级策略</font> **NX**
在编译 Linux 程序代码时，应开启 Linux 程序的 NX 栈不可执行保护选项。
``` shell
gcc -z noexecstack
```

<font color=Green>低级策略</font> **Stripped**
在编译 Linux 程序代码时，需使用 Strip 函数删除调试符号表，以提升逆向分析难度并减少程序体积。

## 设备通信

## 业务逻辑

## 参考文献
[^1]:消费级物联网安全基线，小米，https://github.com/MiSecurity/Cyber-Security-Baseline-for-Consumer-Internet-of-Things
[^2]:什么是攻击面，IBM，https://www.ibm.com/cn-zh/topics/attack-surface

