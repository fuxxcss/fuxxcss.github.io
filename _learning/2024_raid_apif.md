---
title: "APIF: 通用的API模糊测试工具"
excerpt: 'Beyond REST: Introducing APIF for Comprehensive API Vulnerability Fuzzing'

collection: learning
category: paper
permalink: /learning/2024-raid-apif
tags: 
  - raid
  - fuzz
  - api

layout: single
read_time: true
author_profile: false
comments: true
share: true
related: true
---

![](../images/learning/apif.png)

## 背景

在现代软件开发中，应用程序接口（Application Programming Interface，API）发挥着至关重要的作用，因为它们促进了平台互操作性，并充当了数据传输的渠道。

### 一、Web服务API

传统的web应用程序通常采用GET/POST方法来获取用户输入的数据：

1. GET请求用于加载网页或获取资源。
2. POST方法提交表单数据，如用户登录凭据或支付信息。

在更高级的领域，WebSocket api提供客户端和服务器之间的实时双向通信，非常适合聊天应用或实时更新。此外，GraphQL api提供了一种更高效和灵活的方式来查询和操作数据，允许客户精确指定他们需要的数据。

通过探索这些不同的api，开发人员可以识别和解决更广泛的漏洞，例如注入攻击、会话劫持，或者web应用程序中的数据过度获取/不足获取。

### 二、云服务API

对大多数云服务的访问通常是通过RESTFul api提供的，它为各种功能提供了便利。在实践中，不同的请求类型可以从云服务中得到不同的响应。例如，在云计算平台中，客户端可以：

1. 使用GET方法检索当前使用的服务列表。
2. 使用POST方法创建虚拟机实例、容器和数据库。
3. 使用PUT方法更新资源信息。
4. 使用DELETE方法删除特定资源。

通过自动生成并通过云服务的REST API发送请求序列，黑盒测试工具可以探索隐藏在不同状态下的错误，并发现诸如命令注入、数据泄漏和不适当的访问管理等漏洞。

### 三、IoT系统API

在物联网领域，MQTT是一种广泛用于小型传感器和移动设备的轻量级消息传递协议。它能够在物联网设备和服务器之间实现高效和可靠的交易。例如，在MQTT API中，客户机可以：

1. 订阅主题以接收来自设备的更新或传感器数据。
2. 向主题发布消息，向设备发送命令或配置更改。
3. 使用服务质量（QoS）级别，确保消息按所需保证交付。
4. 利用保留的消息为未来的订阅者持久化最后的相关消息。

这些MQTT API操作对于物联网通信的实时、事件驱动性质是不可或缺的。通过严格测试MQTT API消息和主题订阅，安全工具可以识别漏洞，例如不正确的消息处理、不安全的主题订阅和潜在的窃听风险。

## APIF

SOTA的有效性高度依赖于参数结构分析和模糊测试请求生成。然而，现有的方法更多地关注RESTful api，缺乏对其他协议的通用性。此外，测试用例有效性和测试效率方面的不足限制了这些方法在实际场景中的大规模应用。

本文提出了APIF，包含三个创新的设计：

1. 采用树状结构模型对不同API协议中的参数进行解析和变异，提高了通用性。
2. 采用递归解码器解决API参数编码复杂的问题，提高了模糊测试的有效性。
3. 利用测试优先级计算算法和参数无关性分析算法提高了模糊测试效率，使该方法能够广泛应用于现实世界中大规模API漏洞的模糊测试。

整体框架图如下：

![](../images/learning/2024_raid_apif/process.png)

### 一、API参数解析

Fuzzer首先需要了解API的参数结构，然后才能对不同的API参数进行变异测试。参数解析的过程包括抽象化、编码和关系识别两个方面。

**1.参数结构抽象化**

除了RESTful api，还包括web应用中的SOAP和GraphQL等API类型，云应用中的gRPC以及物联网中的MQTT。不同风格和协议的API的参数结构有相似之处，如下图所示。

![](../images/learning/2024_raid_apif/formats.png)

这使得我们可以抽象出统一的表达式方法，使RESTful API的模糊测试技术可以广泛应用于更多的场景。

**2.识别复杂的编码结构和参数关系**

这确保了测试向量准确地针对特定参数，而不干扰其他参数的功能。例如，常见的api利用JSON、XML和各种数组类型对象（参数值中包含嵌套编码）等格式将参数封装在HTTP请求体中。如下图所示，pfile参数值采用base64编码，info参数包含XML结构化数据。

![](../images/learning/2024_raid_apif/encoding.png)

如果没有正确的编码识别和参数解析，盲目更改消息内容进行模糊测试会导致API响应出现格式错误，阻碍漏洞的发现。

**3.实现**

我们实现了从多个协议的API通信中提取参数内容的解析器。最初，我们通过协议特征匹配确定API请求消息的协议。例如：
1. RESTful api可以通过URL模式、版本参数和ACCEPT头等特性有效地识别。
2. GraphQL api可以通过它们的数据结构和特定的操作字段，如“query”、“mutation”或“subscription”来区分。
3. 可以通过XML数据格式和不同的节点（如信封、首部、主体和故障）来识别SOAP api。

递归解码器将尝试解码已编码的参数，如果检测到结构化对象（例如，JSON、XML、数组类型数据等）的存在，则递归解码器将截获的API请求参数中已编码的API参数值转换为树结构，如下图所示。

![](../images/learning/2024_raid_apif/tree.png)

与其他工具相比，重要的创新是测试有效载荷的注入将在树结构中的每个节点上进行，这将模糊测试的粒度从参数级别提升到参数的结构化对象中的每个节点，使我们能够执行非常深入的模糊测试。

### 二、测试优先级计算

该计算用于确定测试api的优先级，并在设定的时间范围内最大化地发现漏洞，从而提高测试效率。借鉴API相关漏洞挖掘的经验和公开漏洞数据集的验证，我们确定了三个评估API漏洞可能性的指标：
1. 用户输入的参数越多，漏洞发生的概率就越大。这是因为很大一部分API漏洞是由对用户输入的不当处理造成的。
2. API中的参数类型越复杂，发现漏洞的可能性就越高。复杂的参数类型意味着API中存在与各种类型数据相关联的查询和功能。
3. 一个API支持的请求方法越多，发现漏洞的可能性就越高。例如，支持GET、POST、UPDATE和DELETE的API访问路径通常涉及更复杂的操作功能和代码逻辑，经常导致有风险的实体操作以及权限问题。

基于上述三个指标，设计了分数体系：
1. 参数覆盖率。这是通过将单个API中的参数数量除以测试范围中所有API的参数总数来计算的。
2. 参数值覆盖率。考虑到参数类型的多样性（例如int、float、str、null、bool），这个比率是通过将单个API中的参数值类型的数量除以测试范围内所有API中的参数值类型的总数来计算的。
3. 操作方法覆盖率。对于具有GET、POST、PUT和DELETE等操作方法的API，我们通过将单个API中操作类型的数量除以测试范围内所有API中操作类型的总数来计算该比率。

### 三、测试向量生成

**1.参数独立性分析**

目前的API模糊测试方法通常每次只改变一个参数，以确保测试全面，这导致了测试数量的增加。为了解决这种低效问题，我们开发了一种参数无关算法。该算法通过分析参数间的相关性，识别api中独立的参数。在黑盒模糊测试中，这允许在每个请求中同时变异多个不相关参数，从而显著减少测试次数，提高漏洞发现效率。

![](../images/learning/2024_raid_apif/dependence.png)

上图显示了在论坛上发布文章的API请求。提交时，系统检查给定的类别值是否已经存在，如果没有找到，则返回错误消息。在单个请求中同时测试类别参数和标题参数的模糊测试器会发现标题的测试向量是无效的。因此，它们需要两个单独的请求来验证这些参数。然而，由于title和authorName是相互独立的，模糊测试器可以在一个请求中对两者进行修改。

**2.参数树变异**

APIF引入了四种基本的变异策略来增强API漏洞模糊测试，基于SecLists：
1. 对特定参数节点的名称或值进行变异，例如，专门向uid参数中注入一个有效载荷。
2. 支持满足特定过滤条件的所有节点的遍历和变异，例如，对所有具有字符串数据类型的节点应用命令注入漏洞测试向量。
3. 在请求参数中添加新节点，例如插入一个名为admin的节点，其值为true，可以帮助绕过权限检查。
4. 支持节点的删除，由于验证策略不充分，删除与身份相关的参数可能会暴露身份验证过程中的漏洞。

![](../images/learning/2024_raid_apif/mutation.png)

这些变异方法能够识别各种类型的API漏洞，并适应不同的API格式，如RESTful、GraphQL、SOAP和gRPC，具有很高的通用性。

**3.重编码**

在用基于SecLists自动生成的测试向量替换原始值之后，使用递归编码器将测试向量重新编码为其原始格式。该过程将树结构恢复为API通信格式，仅将可模糊测试原语的参数值更改为测试向量，同时保持整体请求结构和语法不变。

### 四、漏洞验证

每个测试向量对应一种特定的验证方法，以确定当前API中是否存在安全漏洞并识别其类型。我们将这些方法总结为三种类型：
1. 响应消息中的内容匹配。例如，在使用跨站脚本（XSS）漏洞的模糊测试向量时，我们会验证API响应内容是否包含特定的字符串，如JavaScript有效载荷或注入的DOM元素。类似的方法也适用于数据暴露、文件上传、命令执行等各种类型的漏洞。
2. 基于响应状态码的验证。在API序列的约束求解阶段，一个有效的请求通常具有200状态码。该模型适用于检测状态码不同的漏洞。例如，如果对拒绝服务（DoS）攻击的响应返回状态码503或504，这就证实了API中存在此类漏洞。
3. 根据响应时间进行验证。一个典型的例子是识别基于SQL时间的盲注入漏洞。在这里，如果攻击向量包含SQL的sleep函数，我们就会监控向量嵌入前后响应时间的变化。

基于上述3种验证方法，我们归纳出13种常见的API漏洞类型，包括：数据泄露、命令注入、失效的对象级授权、文件读取漏洞、失效的授权、服务器端请求伪造（SSRF）、SQL注入、安全配置错误、拒绝服务（DoS）、错误处理不当、跨站脚本（XSS）、未实施内容安全策略（CSP）和未验证的重定向。

## 现实世界漏洞测试

将APIF工具应用于真实的漏洞测试中，在60个开源API项目中发现了188个漏洞和26个漏洞。这些易受攻击的应用包括开源应用（如EyouCMS）和云原生API网关服务（如Apache ShenYu）。我们向各自的服务供应商报告了这些漏洞，其中18个已经解决并公开披露，如下图所示。

![](../images/learning/2024_raid_apif/discovery.png)

在测试设置过程中，我们的目标是确保每个测试工具都能充分获取目标程序的API信息。首先，将所有目标测试程序部署在测试环境中；然后，通过配置代理并通过Postman手动触发交互，捕获APIF所需的通信数据；此外，我们为每个目标测试程序生成了相应的OAS文件。测试载荷集统一采用SecLists，单个测试目标的最大运行时间设置为240 min。

## 案例研究：发现CVE-2022-41472

在APIF发现的实际CVE漏洞中，CVE-2022-41472漏洞被识别为一个JSON结构中的跨站脚本（XSS）漏洞。这种方法包括几个步骤。

### 一、获取API

首先，在内部环境中部署待测服务，模拟正常的流量，以原始HTTP消息的形式存储流量，然后将其发送给APIF进行模糊测试。原始的请求消息如下图所示：

![](../images/learning/2024_raid_apif/origin.png)

APIF标识了API /apiadmin/notice/add， API请求消息中的title和content参数已经用base64编码。

### 二、解析API参数

将捕获的API流量递归解码并结构化解析为树结构。如下图所示，在参数值的解码过程中，APIF识别出content参数包含一段HTML代码。因此，在下游添加一个对应的解码节点<p>。通常，当程序渲染用户提交的HTML代码片段时，它很容易受到跨站脚本（XSS）漏洞的影响。

![](../images/learning/2024_raid_apif/parse.png)

### 三、计算测试优先级

通过计算所有API端点存在漏洞的可能性，对高风险API进行优先级排序进行测试。经过计算，/apiadmin/notice/add API在漏洞测试中具有较高的优先级，如下图所示。

![](../images/learning/2024_raid_apif/score.png)

### 四、生成测试向量

在识别高风险api之后，APIF使用约束求解和独立性分析从测试向量库中选择适当的有效载荷，并将它们注入内容节点，如下图所示。

![](../images/learning/2024_raid_apif/mutate.png)

然后对树状结构数据进行恢复编码，生成测试请求，并发送到目标服务器。

### 五、验证漏洞

在获得远程API响应内容后，当使用POST方法时，内置的验证规则通过其JSON体中的title参数确定具有路径 /apiadmin/notice/add 的API易受XSS攻击。在完成自动化检测后，我们手动复制该漏洞以确认其存在，并报告给相关供应商。供应商承认存在该漏洞，并提供了其CVE-2022-41472标识符。